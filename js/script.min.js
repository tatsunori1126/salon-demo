document.addEventListener("DOMContentLoaded",function(){let a=document.getElementById("reservation-modal");if(a){let t=document.getElementById("modal-calendar"),n="",d="",o=0,s="",u="";function l(){var e=new FormData;e.append("action","salon_render_calendar_front"),e.append("menu",n),e.append("staff",d),e.append("week",o),e.append("mode","front"),t.innerHTML="èª­ã¿è¾¼ã¿ä¸­â€¦",fetch(salon_ajax.url,{method:"POST",body:e}).then(e=>e.text()).then(e=>{t.innerHTML=e;e=t.querySelectorAll(".slot-btn");console.log("slot-btn count:",e.length),e.forEach(r=>{r.addEventListener("click",()=>{s=r.dataset.date,u=r.dataset.time,d=r.dataset.staff;var e=document.querySelector("#your-name")||document.querySelector("#f-name"),t=document.querySelector("#your-email")||document.querySelector("#f-email"),n=document.querySelector("#your-tel")||document.querySelector("#f-tel"),o=document.querySelector("#m-menu")||document.querySelector("#res_menu")||document.querySelector("#menu_key"),o=o?.options?.[o.selectedIndex]?.textContent||"-",a=document.querySelector("#m-staff")||document.querySelector("#res_staff")||document.querySelector("#staff_id"),a=a?.options?.[a.selectedIndex]?.textContent||"è‡ªå‹•å‰²å½“",l=document.querySelector("#step-2"),c=document.querySelector("#step-3");document.getElementById("c-name").textContent=e?.value||"-",document.getElementById("c-email").textContent=t?.value||"-",document.getElementById("c-tel").textContent=n?.value||"-",document.getElementById("c-menu").textContent=o,document.getElementById("c-staff").textContent=a,document.getElementById("c-datetime").textContent=s+" "+u,l&&c?(l.style.display="none",c.style.display="block"):console.warn("step-2 ã¾ãŸã¯ step-3 ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")})})}).catch(()=>{t.innerHTML="èª­ã¿è¾¼ã¿å¤±æ•—"})}a.addEventListener("click",t=>{t=t.target.closest(".cal-prev-week, .cal-next-week, .cal-this-week");if(t){let e=o;t.classList.contains("cal-prev-week")&&e--,t.classList.contains("cal-next-week")&&e++,(e=t.classList.contains("cal-this-week")?0:e)<0?console.log("â›” éå»é€±ã¸ã®åˆ‡ã‚Šæ›¿ãˆã¯ç„¡åŠ¹"):(o=e,console.log("ğŸŒ€ ãƒ¢ãƒ¼ãƒ€ãƒ«é€±åˆ‡ã‚Šæ›¿ãˆ:",o),l())}}),a.addEventListener("change",e=>{n=document.querySelector("#m-menu")?.value||document.querySelector("#res_menu")?.value||document.querySelector("#menu_key")?.value||"default",d=document.querySelector("#m-staff")?.value||document.querySelector("#res_staff")?.value||document.querySelector("#staff_id")?.value||"",e.target.matches("#m-staff, #res_staff, #staff_id")&&(n&&"default"!==n&&"0"!==n?(console.log("ğŸŒ€ æ‹…å½“å¤‰æ›´ â†’ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†èª­ã¿è¾¼ã¿",{menu:n,staff:d,week:o}),l()):console.log("âš  ãƒ¡ãƒ‹ãƒ¥ãƒ¼æœªé¸æŠã®ãŸã‚ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—"))}),a.addEventListener("click",e=>{var t=e.target.closest(".btn-week");t?(e.preventDefault(),"prev"===(t=t.dataset.week)&&o--,"next"===t&&o++,"today"===t&&(o=0),n=document.querySelector("#m-menu")?.value||document.querySelector("#res_menu")?.value||document.querySelector("#menu_key")?.value||"cut",d=document.querySelector("#m-staff")?.value||document.querySelector("#res_staff")?.value||document.querySelector("#staff_id")?.value||0,console.log("ğŸ“¤ é€ä¿¡ãƒ‡ãƒ¼ã‚¿:",{menu:n,staff:d,week:o}),l()):(t=e.target.closest(".slot-btn"))&&(e.preventDefault(),a.querySelectorAll(".slot-btn.selected").forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),s=t.dataset.date,u=t.dataset.time,d=t.dataset.staff,e="1"===t.dataset.autoassign?"è‡ªå‹•å‰²å½“":document.querySelector("#m-staff")?.selectedOptions?.[0]?.textContent||"-",console.log(`é¸æŠ: ${s} ${u} / ã‚¹ã‚¿ãƒƒãƒ•: `+e),document.getElementById("c-menu").textContent=document.querySelector("#m-menu")?.selectedOptions?.[0]?.textContent||"-",document.getElementById("c-staff").textContent=e,document.getElementById("c-datetime").textContent=s+" "+u,step2&&step3?(step2.style.display="none",step3.style.display="block"):console.warn("âš  step2 ã¾ãŸã¯ step3 ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"))})}}),jQuery(function(o){let a=0;function t(){var e=o("#menu_key").val()||o("#res_menu").val()||"cut",t=o("#staff_id").val()||o("#res_staff").val()||3,n=(console.log("ğŸ“¤ é€ä¿¡ãƒ‡ãƒ¼ã‚¿:",{menuKey:e,staffId:t,currentWeek:a}),new FormData);n.append("action","salon_render_calendar_public_readonly"),n.append("menu_key",e),n.append("staff_id",t),n.append("week",a),fetch(salon_ajax.url,{method:"POST",body:n}).then(e=>e.text()).then(e=>{o("#readonly-calendar").html(e)}).catch(()=>alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"))}o.ajaxSetup({cache:!1}),o("body").off("click.salonNextWeek").on("click.salonNextWeek","#next-week",function(e){e.preventDefault(),a++,t()}),o("body").off("click.salonPrevWeek").on("click.salonPrevWeek","#prev-week",function(e){e.preventDefault(),a--,t()}),t()}),document.addEventListener("DOMContentLoaded",function(){let l=document.querySelector(".salon-calendar-wrapper");if(l){let o=l.querySelectorAll(".salon-calendar-tabs .tab"),a=l.querySelector("#salon-calendar-content");o.forEach(e=>{e.addEventListener("click",function(){o.forEach(e=>e.classList.remove("active")),this.classList.add("active");var e=this.dataset.staff,t=l.dataset.menu,n=l.dataset.week;a.innerHTML='<p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>',fetch(ajaxurl+"?_="+Date.now(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"salon_load_calendar",staff_id:e,menu_key:t,week:n})}).then(e=>e.text()).then(e=>{a.innerHTML=e,console.log("âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æœ€æ–°çŠ¶æ…‹ã§å†æç”»ã—ã¾ã—ãŸ")}).catch(e=>{console.error("âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",e),a.innerHTML='<p class="error">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>'})})})}}),document.addEventListener("DOMContentLoaded",function(){let u=document.getElementById("confirm-btn");u?u.addEventListener("click",async e=>{if(e.preventDefault(),!u.disabled){console.log("âœ… äºˆç´„ç¢ºå®šãƒœã‚¿ãƒ³æŠ¼ä¸‹");var e=document.querySelector("#your-name")||document.querySelector("#f-name"),t=document.querySelector("#your-email")||document.querySelector("#f-email"),n=document.querySelector("#your-tel")||document.querySelector("#f-tel"),o=(document.querySelector("#m-menu")||document.querySelector("#res_menu")||document.querySelector("#menu_key"))?.value||"default",a=(document.querySelector("#m-staff")||document.querySelector("#res_staff")||document.querySelector("#staff_id"))?.value||0,[l,c]=(document.getElementById("c-datetime")?.textContent?.trim()||"").split(" ");if(salon_ajax&&salon_ajax.url&&salon_ajax.nonce){console.log("ğŸ“¦ é€ä¿¡ãƒ‡ãƒ¼ã‚¿",{selDate:l,selTime:c,selMenuKey:o,selStaffId:a});var r=new FormData;r.append("action","salon_submit_reservation"),r.append("nonce",salon_ajax.nonce),r.append("name",e?.value||""),r.append("email",t?.value||""),r.append("tel",n?.value||""),r.append("menu",o),r.append("staff",a),r.append("date",l),r.append("time",c),u.disabled=!0,u.textContent="é€ä¿¡ä¸­...";try{var d,s=await(await fetch(salon_ajax.url,{method:"POST",body:r})).json();console.log("ğŸ“¥ å¿œç­”:",s),u.disabled=!1,u.textContent="ã“ã®å†…å®¹ã§ç¢ºå®š",s.success?(console.log("âœ… äºˆç´„æˆåŠŸ"),(d=document.querySelector(".modal, .p-reservation__modal, .reservation-modal"))&&(d.classList.remove("is-active","open","show","active"),d.style.display="none",d.style.opacity="0",d.style.pointerEvents="none",d.style.visibility="hidden"),window.location.href=`${location.origin}/reservation-thanks/?menu=${encodeURIComponent(o)}&date=${encodeURIComponent(l)}&time=`+encodeURIComponent(c)):alert(s.data?.msg||"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")}catch(e){console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:",e),u.disabled=!1,u.textContent="ã“ã®å†…å®¹ã§ç¢ºå®š",alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")}}else alert("nonceãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚functions.php ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"),console.error("âŒ salon_ajax ãŒæœªå®šç¾©ã¾ãŸã¯ nonce ãŒå­˜åœ¨ã—ã¾ã›ã‚“")}}):console.warn("âš ï¸ confirm-btn ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")}),document.addEventListener("DOMContentLoaded",()=>{setInterval(()=>{fetch(ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"salon_get_last_update"})}).then(e=>e.json()).then(e=>{if(e.success&&e.data&&e.data.date){let n=e.data;e=document.querySelector(`.cal-table th:contains("${n.date.split("-").slice(1).join("/")}")
        `);e&&e.closest(".cal-table").querySelectorAll("tbody tr").forEach(e=>{var t=e.querySelector("th");(t?t.textContent.trim():"")===n.time&&(t=e.querySelector("td.available, td.booked"))&&(t.className=0<n.staff?"booked":"available",t.textContent=0<n.staff?"Ã—":"â—‹")})}}).catch(e=>console.error("æ›´æ–°ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:",e))},3e3)});